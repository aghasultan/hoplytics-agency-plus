name: Hoplytics CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['8.2', '8.3']
        node-version: ['20']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: wp-cli
          coverage: none

      - name: PHP Syntax Check
        run: find . -name '*.php' -not -path './node_modules/*' -not -path './_archive/*' -not -path './vendor/*' | xargs -I {} php -l {} | grep -v "No syntax errors"

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Lint CSS
        run: npm run lint:css
        continue-on-error: true

      - name: Lint JS
        run: npm run lint:js
        continue-on-error: true

      - name: Build Production Assets
        run: npm run build

      - name: Verify Manifest Exists
        run: test -f dist/.vite/manifest.json && echo "✅ Manifest found" || (echo "❌ No manifest" && exit 1)

      - name: Generate i18n .pot
        run: |
          mkdir -p languages
          wp i18n make-pot . languages/hoplytics.pot --domain=hoplytics --exclude=node_modules,dist,_archive,vendor

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: theme-build-php${{ matrix.php-version }}
          path: |
            dist/
            languages/hoplytics.pot
          retention-days: 7
